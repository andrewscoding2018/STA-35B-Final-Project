---
title: "SidAndrewFinalProject"
author: "Andrew Kuang"
date: "`r Sys.Date()`"
output: pdf_document
---

```{r}
library(tidyverse)
```


# Question 1. File Linkage Integrity

## a) Read the four CSV files into R, building four data frames with the names “Cases”, “Parents”, “Children” and “Payments”. Show the dimensions of these data frames. (You may find it useful to save these data frames as Rdata objects in a file using the save command. You can then recover them with the load command more quickly than reading the CSV file.)

```{r}

csvToDf = function(v) {
  return(as.data.frame(read.csv(v)))
  
}

cases <- csvToDf("cases.csv")
parents <- csvToDf("parents.csv")
children <- csvToDf("children.csv")
payments <- csvToDf("payments.csv")

```

## b) What is the distribution of the number of children attached to a case? Show an appropriate plot of the distribution, and mark the location of the average number in the plot.

```{r}

number <- children %>% select(CASE_NUM, ID) %>% group_by(CASE_NUM) %>% mutate(numberchildren = length(ID)) %>% ungroup(CASE_NUM) %>% summarize(mean(numberchildren))


children %>% select(CASE_NUM, ID)%>% group_by(CASE_NUM) %>% mutate(numberchildren = length(ID)) %>%
  ggplot(mapping = aes(x = numberchildren)) + geom_histogram(binwidth = 1) + geom_vline(xintercept = as.numeric(number), size = 5, color = "red")
  

```
## c) The file children.csv may have more than one record for each child. What is the largest number of cases associated with a child, and indicate why you believe that this is indeed the same child.

```{r}

children %>% select(ID, CASE_NUM) %>% group_by(ID) %>% mutate(childCaseCount = n()) %>% tally() %>% summarize(max(n))
```

This is the same child because we grouped by ID, which identifies the child. Timmy has 12 cases of child support, as a child needing support. 

## d) Does every absent parent (AP_ID) identified in the payments data have an identifying record in the parents data file?

```{r}
# Gets all the unique AP_IDs from the payments data file
payments_AP_ID <- payments %>% select(AP_ID) %>% arrange() %>% pull()
payments_AP_ID <- unique(payments_AP_ID)

# Gets all the unique AP_IDs from the payments data file
parents_AP_ID <- parents %>% select(AP_ID) %>% arrange() %>% pull()
parents_AP_ID <- unique(parents_AP_ID)

# Checks if AP_IDs are identical
identical(payments_AP_ID, parents_AP_ID)
```

# Question 2: Recoding Categories

Some categorical variables among these data frames are sparse (seldom observed). For example, the variable PYMNT_SRC in Payments has category ‘M’ with 2 cases and category ‘R’ with 7. These are too few for modeling in regression.

Write a function named “pool_categories” that recodes a categorical variable into a “simpler” factor with fewer categories by pooling categories with counts below a threshold into a category labeled ‘Other’ (a factor level which your function should check does not already exist!). You might find the R function %in% useful for this exercise.

```{r}

payments.short <- payments %>% slice(1:1000)

pool_categories = function(variable, min){
  
  nameUse <- "Other";
  
  var.copy <- variable
  var_factor <- as.factor(var.copy)
  var_levels <- levels(var_factor)
  
  if(length(which(var_levels %in% "Other")) != 0)nameUse <- "Other1";
  
  levels(var_factor) <- c(levels(var_factor), nameUse)
  
  for(level in var_levels){
    if(sum(var.copy %in% level) < min){
      var.copy[which(variable == level)] <- nameUse
    }
  }
  return(as.factor(var.copy)) 
}

pool_categories(payments.short$PYMNT_SRC, 100)

```

# Question 3: Payment counts and amounts
## a) Make a variable Payments$DATE which is a viable R date by converting the COLLECTION_DT variable. Use this variable to find (i) the range of dates of all payments and (ii) the percentage of the total number of payments made before May 1, 2015.

```{r}
library(lubridate) # Aids in dealing with dates and times
```

```{r}
# Part i)
payments$DATE <- mdy_hms(payments$COLLECTION_DT) # Converts COLLECTION_DT to Date type and stores it in DATE column

range(payments$DATE) # Gets the range of dates

# Part ii)
payments_made <- payments %>% filter(DATE < as.Date("2015-05-01")) # Returns a df of payments made before 2015-05-01
perc_payments_made <- (nrow(payments_made) / length(payments$DATE)) * 100 # Percentage of payments made before 2015-05-01
perc_payments_made
```

## (b) Show a sequence plot of the total number of payments made on each day from May 1, 2015 through the end of the data.
```{r}
payments %>% group_by(DATE) %>% summarize(daily_pymt = length(PYMNT_AMT)) %>% filter(DATE >= as.Date("2015-05-01")) %>% ggplot(mapping = aes(x = DATE, y = daily_pymt)) + 
  geom_point()
```

## (c) What explains the bimodal shape of the marginal distribution of the number of payments over this time period? Explain with some evidence how you reached your opinion.

```{r}
payments %>% group_by(DATE) %>% summarize(daily_pymt = length(PYMNT_AMT)) %>% filter(DATE >= as.Date("2015-05-01")) %>% ggplot(mapping = aes(x = daily_pymt)) + 
  geom_density()
```

*Come back to this!!*
Since we know that there is one payment made per child, the number of daily payments made is equivalent to the number


## (d) Describe the distribution of the payment amounts. Do you have an explanation for its shape? (You
might find it useful to work with a sample for plotting. R takes a while to draw 1.5 million points.)

First, let's graph the distribution with a sample of 100,000 points:

```{r}
sample_n(payments, 100000) %>% ggplot(mapping = aes(x = log(PYMNT_AMT))) + geom_density()
```
We can see that payment amount is far less before 2015. Furthermore, we can also see that there is only one "level" of payment before 2015, whereas after we can see that there are several different levels of payment.


```{r}
inner_join(children, payments, by = "CASE_NUM") %>% select(CASE_NUM, ID, PYMNT_AMT, DATE) %>% filter(DATE >= as.Date("2015-01-01")) %>% group_by(DATE) %>% summarize(num_child = length(PYMNT_AMT))
```

# Question 4: Payments for Cases

The unit of analysis for this question is the payment behavior of an absent parent. Hence, if the parent is involved in several cases, you will need to accumulate the relevant information. You may find it useful for this and the next question to build a data frame for parents that collects the relevant information for each parent. You may find dplyr useful here and elsewhere, but you don’t have to use it.

## (a) It has been conjectured that parents deemed responsible for more children are more likely to make either a larger number of payments or a larger total payment amount over this period. Is that true?

* First, we join the children and payments data sets in order to find the number of children per absent parent
  + We also summarize the number of payments made, as well as the sum of these payments to see if there is any correlation between number of children and number of payments / total payment amount
    
```{r}
children_and_pymnts <- left_join(children, payments, by = "CASE_NUM") %>% group_by(AP_ID) %>% 
  summarize(num_child = length(unique(ID)), num_pymnt = length(PYMNT_AMT), total_pymnt = sum(PYMNT_AMT))

head(children_and_pymnts)
```

* Next, we check if there are any NA values for us to omit

```{r}
children_and_pymnts %>% filter(is.na(AP_ID)) # Finds NA row

children_and_pymnts_cln <- na.omit(children_and_pymnts) # Removes NA row

nrow(children_and_pymnts) - nrow(children_and_pymnts_cln) # Checks number of rows removed (it should only be 1!)
```

* We want to test whether "parents deemed responsible for more children are more likely to make either a larger number of payments or a larger total payment amount over this period"
  + For this, we can compare the correlations of "number of children vs number of payments" and "number of children vs total payments"

```{r}
cor(children_and_pymnts_cln$num_child, children_and_pymnts_cln$num_pymnt) # Number of children vs number of payments
cor(children_and_pymnts_cln$num_child, children_and_pymnts_cln$total_pymnt) # Number of children vs total payments
```

* We can see from the respective Pearson Correlation Coefficients that parents deemed responsible for more children are more likely to make a larger total payment over the time period rather than make more payments

# Question 5: Consistency